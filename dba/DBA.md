# Администрирование СУБД PostgreSQL


<div>
    <img src="https://github.com/devicons/devicon/blob/master/icons/linux/linux-original.svg" width="40" height="40"/>&nbsp;
    <img src="https://github.com/devicons/devicon/blob/master/icons/postgresql/postgresql-original.svg" width="40" height="40"/>&nbsp;
</div>


### Установка и использование PostgreSQL в Linux

<b>PostgreSQL</b> — программа, которая относится к классу <em>систем управления базами данных</em>. Когда эта программа выполняется, она становится <em>сервером PostgreSQL</em> или <em>экземпляром сервера</em>. Данные, которыми управляет PostgreSQL, хранятся в базах данных. Один экземпляр PostgreSQL одновременно работает с несколькими базами данных. Этот набор баз данных называется <em>кластером баз данных</em>.

* <b>Кластер баз данных</b> - это данные в файлах; 
* <b>Cервер или экземпляр сервера</b> - программа, управляющая кластером баз данных.

[Источник пакетной установки PostgreSQL](https://www.postgresql.org/download/)

<em>Здесь и далее рассматривается пакет PostgreSQL 14.11 для Ubuntu.</em>


Для инициализации кластера в Ubuntu создана обертка `pg_createcluster` над утилитой `initdb`. Эта утилита автоматически запускается при установке пакета и создает кластер баз данных с именем "main". Стоит обратить внимание, что инициализация кластера проходит с отключенным подсчетом контрольных сумм в страницах данных.Исполняемые файлы, файлы конфигурации и журнал сервера размещены в соответствии с правилами, принятыми в Ubuntu. Кроме того, настраивается автоматический запуск и останов сервера PostgreSQL при запуске и останове операционной системы.

Для удаления кластера используется утилита `pg_dropcluster`. Утилиты `pg_createcluster` и `pg_dropcluster` специфичны для Ubuntu. В других системах нужно явно инициализировать кластер с помощью `initdb` и задействовать подходящие средства операционной системы.

К основным операциям управления сервером относятся запуск и останов сервера, получение текущего статуса сервера, обновление конфигурации и некоторые другие. Для выполнения этих действий предназначена утилита `pg_ctl`, идущая в составе PostgreSQL. Но в пакетном дистрибутиве для `Ubuntu` доступ к утилите `pg_ctl` осуществляется не напрямую, а через специальную обертку `pg_ctlcluster`. В других системах утилита pg_ctl может использоваться непосредственно.

`sudo pg_ctlcluster 14 main status`     получить текущий статус сервера
`sudo pg_ctlcluster 14 main start`      запустить сервер
`sudo pg_ctlcluster 14 main stop`       остановить сервер
`sudo pg_ctlcluster 14 main restart`    переапустить сервер


##### Расчет контрольных сумм

Контроль расчетных сумм в PostgreSQL необходим для обеспечения правильности данных, а также для обнаружения любых возможных ошибок или несоответствий в базе данных. Это позволяет избежать потенциальных проблем, связанных с неверными результатами вычислений или сбоями в программном обеспечении. Такой контроль также помогает обнаруживать несанкционированные изменения данных и предотвращать возможные атаки на систему.

`sudo /usr/lib/postgresql/14/bin/pg_checksums --check -D /var/lib/postgresql/14/main`   узнать, включен ли расчет контрольных сумм

`sudo /usr/lib/postgresql/14/bin/pg_checksums --enable -D /var/lib/postgresql/14/main`      включение расчета контрольных сумм


### Основные команды PostgreSQL в терминале Linux

`sudo apt-get --purge remove postgresql\*`  удаление PostgreSQL и всех его компонентов

`sudo apt install postgresql`   установка PostgreSQL

`sudo ls -l /usr/lib/postgresql/14/bin`     каталог установки PostgreSQL

`sudo service postgresql status`    проверка, запущен ли сервис

`sudo service postgresql start`     запуск сервера если он не запущен

`sudo service postgresql restart`   перезапуск сервера postgresql

`sudo service postgresql stop`  остановка сервера postgresql

`sudo service postgresql stop -m immediate --skip systemctl-redirect`   остановка сервера postgresql без выполнения контрольной точки

`sudo pg_isready`       проверка, готов ли сервер postgresql принимать подключение от клиентов

`sudo -u postgres psql`     подключение к серверу, активация оболочки <b>psql</b>

`psql -h localhost -U user_name -d db_name`     подключение по локальной сети к базе данных под определенным пользователем

`psql -h localhost -U user_name -d db_name -c "SELECT * FROM table" > /path/to/file/output.txt`     запись результата запроса в файл

`psql < filename` или `psql -f filename`    выполнение файла

`sudo tail -n 10 /var/log/postgresql/postgresql-14-main.log`    вывод 10 последних записей из журнала сообщений сервера

`\q`    выход из <b>psql</b>


### Установка pgAdmin4

1. Установка из репозитория <b>pgAdmin4 APT</b>:

`curl https://www.pgadmin.org/static/packages_pgadmin_org.pub | sudo apt-key add`

`sudo sh -c 'echo "deb https://ftp.postgresql.org/pub/pgadmin/pgadmin4/apt/$(lsb_release -cs) pgadmin4 main" > /etc/apt/sources.list.d/pgadmin4.list && apt update'`

2. Запуск установки <b>pgAdmin4</b>:

`sudo apt install pgadmin4`

3. Запуск скрипта, устанавливающего веб-компоненты. Скрипт находится по адресу `/usr/pgadmin4/bin/setup-web.sh`.

4. В процессе установки будет перезапущена служба Apache2. После завершения работы скрипта необходимо добавить разрешение для Apache2 на доступ через брэндмауэр:

`sudo ufw allow 'Apache'`

5. Запуск брэндмауэра:

`sudo ufw enable`

6. Убедиться, что Apache2 включена в список разрешенных в брэндмауэре:

`sudo ufw status`

7. Для доступа к веб-версии pgAdmin4 ввести в браузере:

`http://<ip-адрес:порт>/pgadmin4`


### Основные команды PSQL

`\! clear`  очистить терминал

`\l`    список баз данных

`\c <db_name>`  подключение к базе данных

`\x`    смена формата вывода результатов запросов (вертикально/горизонтально)

`\dt`   список таблиц базы данных

`\dt <schema_name>.*`   список таблиц определенной схемы

`\du`   список пользователей

`\dn`   список схем базы данных

`\dL`   список установленных языков программирования

`\df`   список функций и процедур базы данных

`\dx`   список расширений базы данных

`\dT`   список составных типов базы данных

`\db`   список табличных пространств

`\dRp+`     список публикаций для логической репликации

`\dew`      список оберток внешних данных

`\des+`     список внешних серверов

`\det`      список внешних таблиц

`\dp <username>.<table>`    список привелегий для таблицы у пользователя

`\i <path_to_file_sql>`    открытие файла (используется для запуска скриптов .sql)

`\gx`   расширенный режим отображения, только для одного запроса (ставится вместо точки с запятой)


##### Запись результатов запроса в файл

`\o output.txt`     создание файла

`SELECT schemaname, tablename, tableowner FROM pg_tables LIMIT 5;`

`\! cat output`


### Конфиурирование сервера PostgreSQL

Вывод всех незакоментированных параметров конфигурации из файла `postgresql.conf`:
```sql
SELECT sourceline, name, setting, applied
FROM pg_file_settings
WHERE sourcefile LIKE '/etc/postgresql/14/main/postgresql.conf';
```

Вывод действующих значений параметров из представления `pg_settings`:
```sql
SELECT name, setting, unit,
  boot_val, reset_val,
  source, sourcefile, sourceline,
  pending_restart, context
FROM pg_settings
WHERE name = '<параметр>'\gx
```

Ключевые колонки представления `pg_settings`:
* <b>name</b>, <b>setting</b>, <b>unit</b> — название и значение параметра;
* <b>boot_val</b> — значение по умолчанию;
* <b>reset_val</b> — значение, которое восстановит команда RESET;
* <b>source</b> — источник текущего значения параметра;
* <b>pending_restart</b> — значение изменено в файле конфигурации, но для применения требуется перезапуск сервера.

Столбец `context` определяет действия, необходимые для применения параметра. Среди возможных значений:
* <em>internal</em> — изменить нельзя, значение задано при установке;
* <em>postmaster</em> — требуется перезапуск сервера;
* <em>sighup</em> — требуется перечитать файлы конфигурации;
* <em>superuser</em> — суперпользователь может изменить для своего сеанса;
* <em>user</em> — любой пользователь может изменить для своего сеанса.


Перечитать файлы конфигурации чтобы изменить значение параметра во всех сеансах:
```sql
SELECT pg_reload_conf();
```


#### postgresql.auto.conf

Файл конфигурации, управляемый командами SQL. Этот файл не следует изменять вручную. Для его редактирования предназначена команда `ALTER SYSTEM`. По сути, эта команда представляет собой SQL-интерфейс для управления параметрами конфигурации.

Для применения изменений, сделанных командой `ALTER SYSTEM`, сервер должен перечитать конфигурационные файлы, как и в случае с изменением файла postgresql.conf. Содержимое обоих файлов (postgresql.conf и postgresql.auto.conf) можно увидеть через представление `pg_file_settings`. А актуальные значения параметров — в представлении `pg_settings`.

```sql
ALTER SYSTEM SET port TO 5433;
```
или
```sql
SELECT set_config('port', 5433, false);
```

Третий параметр функции `set_config` говорит о том, нужно ли устанавливать значение только для текущей транзакции (true) или до конца работы сеанса (false). Это важно при работе приложения через пул соединений, когда в одном сеансе могут выполняться транзакции разных пользователей.


```sql
SHOW port;
```
или
```sql
SELECT current_setting('port');
```

`ALTER SYSTEM RESET <параметр>`     удаляет строку

`ALTER SYSTEM RESET ALL`    удаляет все строки из postgresql.auto.conf


Процесс изменения параметра `work_mem`:
```sql
ALTER SYSTEM SET work_mem TO '128MB';

SELECT pg_reload_conf();
```

Установка параметров внутри транзакции:
```sql
BEGIN;
SET LOCAL work_mem TO '64MB'; 
SHOW work_mem;
COMMIT;
SHOW work_mem;

 work_mem 
----------
 64MB
(1 row)

COMMIT;

SHOW work_mem;

 work_mem 
----------
 8MB
(1 row)
```

<em>После завершения транзакции значения восстанавливаются. </em>


### Роли и привелегии

`CREATE ROLE <роль> [WITH] <атрибут> [атрибут ...]`

<em>LOGIN</em>   возможность подключения

<em>SUPERUSER</em>   суперпользователь

<em>CREATEDB</em>    возможность создавать базы данных

<em>CREATEROLE</em>  возможность создавать роли

<em>REPLICATION</em>     использование протокола репликации

и др.

Создаем базу данных
```sql
CREATE DATABASE access_roles;`
```

Подключение к базе данных
`\c access_roles`

Создаем роль для пользователя alice (появляется возможность подключаться и создавать новые роли)
```sql
CREATE ROLE alice LOGIN CREATEROLE;
```

Подключаемся к базе данных под именем alice

\с - alice

или

`psql -h localhost -U alice acces_roles`

Создание новой роли от alice
```sql
CREATE ROLE bob LOGIN;
```

##### Предопределенные роли

`pg_read_all_settings`  чтение всех параметров сервера

`pg_read_all_stats`     доступ к статистике

`pg_stat_scan_tables`   мониторинг и блокировки таблиц

`pg_read_all_data`      чтение данных из всех таблиц

`pg_write_all_data`     изменение данных во всех таблицах

`pg_read_server_files`      чтение файлов на сервере

`pg_write_server_files`     запись в файлы на сервере

`pg_execute_server_programs`    выполнение программ на сервере


##### Примеры использования управления привелегиями

`CREATE ROLE new_user WITH LOGIN PASSWORD 'new_password' VALID UNTIL '2022-12-31';`      создание пользователя и пароля и установление срока учетной записи

`GRANT ALL PRIVILEGES ON DATABASE your_database TO your_username;`      предоставление привелегий новому пользователю

`GRANT CREATE, USAGE ON SCHEMA alice TO bob`    предоставление привелегий пользователю bob на создание и использование схем

`ALTER ROLE your_username NOLOGIN;`     лишение пользователя возможности подключения в базе данных

`GRANT alice TO postgres;`   включение alice в роль postgres

`REVOKE alice TO postgres;`  исключение alice из роли postgres


##### Access priveleges

* a - INSERT
* r - SELECT
* w - UPDATE
* d - DELETE
* D - TRUNCATE
* x - REFERENCE
* t - TRIGGER


### Очистка дискового пространства

1. <b>VACUUM</b>: Эта команда выполняет процесс автоматического освобождения пространства в таблицах, которое было выделено для удаленных, обновленных или вставленных строк. Она также обновляет статистику таблицы, которая используется оптимизатором запросов для выбора наиболее эффективных планов выполнения запросов.

2. <b>VACUUM VERBOSE</b>: Параметр VERBOSE указывает на то, что при выполнении операции VACUUM будет выводиться более подробная информация о процессе. Это может включать в себя данные о количестве освобожденного пространства, времени выполнения операции, а также другие дополнительные сведения. Указание параметра VERBOSE делает вывод информации более информативным и обычно используется для отслеживания прогресса операции и оценки ее эффективности.

3. <b>VACUUM FULL</b>: Эта команда выполняет более интенсивный процесс очистки и компактации таблицы. Она перемещает данные из таблицы в новое физическое расположение, освобождая пространство, которое занимали удаленные строки. Однако, <b>VACUUM FULL</b> блокирует таблицу на время выполнения операции и может быть более ресурсоемкой по сравнению с обычным <b>VACUUM</b>.

В целом, <b>VACUUM</b> обычно достаточно для поддержания эффективности работы базы данных, однако, при необходимости выполнить более глубокую очистку и компактацию таблицы, может использоваться <b>VACUUM FULL</b>. Вариант этой команды с ключевым словом <b>CONCURRENTLY</b> работает дольше, но не блокирует индекс и не мешает чтению и обновлению данных


### Подсчет контрольных сумм

Проверка, включено ведение контрольных сумм (по-умолчанию отключено):
```sql
SHOW pg_checksums;
```

`sudo service postgresql stop`

или

`sudo systemctl stop postgresql@14-main`    отключение сервера

`su - postgres -c '/usr/lib/postgresql/12/bin/pg_checksums --enable -D "/var/lib/postgresql/12/main"'`  включение ведения контрольных сумм на сервере

`sudo systemctl start postgresql@14-main`


### Резервное копирование

Резервное копирование - это процесс создания резервных копий данных и хранения их для предотвращения потери важных данных в случае сбоя или ошибки. Резервное копирование обычно используется для восстановления данных в случае катастрофической потери данных.

Все команды выполняются от имени postgres.

##### Логическая копия

* <b>COPY</b> 
COPY используется для копирования данных между таблицей и файлом или между таблицей и другой таблицей. Эта команда предоставляет отличную производительность при загрузке или выгрузке большого объема данных.

Копирование данных из файла в таблицу:
`COPY employees FROM '/path/to/employees.csv' DELIMITER ',' CSV HEADER;`


Копирование данных из таблицы в файл:
`COPY employees TO '/path/to/employees.csv' DELIMITER ',' CSV HEADER;`


DELIMITER ',' указывает, что данные в файле разделены запятыми, и CSV HEADER указывает, что первая строка содержит заголовки столбцов.

Параметры COPY могут включать опции формата данных (CSV, TEXT), разделитель, заголовки, игнорирование ошибок и другие. Кроме того, с помощью COPY можно копировать данные между таблицами, указывая имя целевой таблицы вместо имени файла:
`COPY employees TO employees_copy;`


* <b>pg_dump</b>
Выгружает базу данных в виде скрипта или в архивном формате. `pg_dump` — это программа для создания резервных копий базы данных PostgreSQL. Она создаёт целостные копии, даже если база параллельно используется. Программа `pg_dump` не препятствует доступу других пользователей к базе данных (ни для чтения, ни для записи).

По-умолчанию, файл с дампом будет создан в рабочем каталоге, из которого выполняется команда. Также можно указать абсолютный путь до файла вместо просто имени файла.

Выгрузка в SQL:
`pg_dump -h hostname -U dbuser -f dump.sql dbname`

Восстановление дампа:
`psql -d dbname -f dump.sql
`

База данных не создастся данной командой. Базу данных нужно предварительно создать в psql от template0. Также к моменту восстановления дампа должны уже существовать все пользователи, которые имели права на объекты, иначе произойдет ошибка.

`--create`  cформировать в начале вывода команду для создания базы данных и затем подключения к ней 

`--file=файл`   отправить вывод в указанный файл

`--format=формат`   

По-умолчанию действует формат `plain`. Серьезное ограничение этого формата состоит в том, что выбирать объекты нужно в момент выгрузки. 
Формат custom позволяет сначала сделать полную копию, а выбирать объекты уже при загрузке. 
Формат directory интересен тем, что позволяет выгружать данные в несколько параллельных потоков. При этом гарантируется согласованность данных: все потоки будут использовать один и тот же снимок данных.


* <b>pg_dumpall</b>
Создает резервную копию всего кластера баз данных, включая все роли и табличные пространства. Поскольку pg_dumpall требуется доступ ко всем объектам всех БД, запускать ее следует суперпользователю или пользователю, включенному в предустановленную роль pg_read_all_data. Результатом работы pg_dumpall является скрипт для psql. Другие форматы не поддерживаются.

Дамп всего кластера:
`pg_dumpall -h hostname -p 5432 -U postgres -f dumpall.sql`

Восстановлени полученной копии:
`psql -f dampall.sql postgres`


Дамп со сжатием:
`pg_dump db_name | gzip > filename.gz`

`gunzip -c filename.gz | psql db_name`


`sudo -u postgres pg_dump -d test_db --table=t | psql -d test_db2`  копирование таблицы с содержимым в другую базу данных

`sudo -u postgres pg_dump -d test_db --create`  копия базы данных в виде SQL-скрипта, которая выводится в консоль (stdin)


* <b>pg_restore</b>
Утилита командной строки, предназначенная для восстановления резервной копии. Она позволяет восстановить базу данных из архивного файла, который был создан с помощью pg_dump.

Восстановление базы данных из архивного файла:
`pg_restore -d dbname filename`


Восстановление только схемы базы данных (эта команда восстановит только структуру базы данных без данных):
`pg_restore -s -d dbname filename`


Восстановление только данных без схемы (эта команда загрузит только данные в базу данных без создания таблиц и других объектов):
`pg_restore -a -d dbname filename`


Восстановление базы данных с кастомными параметрами:
`pg_restore -C -d dbname -h localhost -U username filename`

-------------------------------------------------------------------------------------------------------

### Полезные функции PostgreSQL

##### Вывод размера (базы данных, табличных пространств)
```sql
SELECT pg_size_pretty(pg_database_size('<название_базы_данных>')),
        pg_size_pretty(pg_tablespace_size('<название_табличного пространства>'));
```

##### Вывод размера объекта базы данных (таблица, индекс и т.д.)
```sql
SELECT pg_size_pretty(pg_total_relation_size('<название_объекта>')) AS object_size;
```

##### Вывод информации о параметрах конкретной базы данных
```sql
SELECT * FROM pg_database WHERE datname = '<название_базы_данных>';
```

##### Вывод всех таблиц определенной схемы базы данных
```sql
SELECT tablename, tablespace FROM pg_tables WHERE schemaname = '<название_схемы_базы_данных>';
```

##### Вывод пути файла
```sql
SELECT pg_relation_filepath('<название файла>');
```

##### Вывод информации из файла pg_hba.conf в виде таблицы
```sql
SELECT line_number, type, database, username, address, auth_method
FROM pg_hba_file_rules;
```

##### Вывод информации о процессе по его pid
```sql
SELECT query, backend_type, wait_event_type, wait_event
FROM pg_stat_activity WHERE pid = <номер процесса>;
```

##### Вывод всех незакоментированных параметров конфигурации из файла postgresql.conf
```sql
SELECT sourceline, name, setting, applied
FROM pg_file_settings
WHERE sourcefile LIKE '/etc/postgresql/13/main/postgresql.conf';
```