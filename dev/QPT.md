# Оптимизация запросов

Можно выделить два основных подхода оптимизации. Первый состоит в том, чтобы отслеживать состояние системы и добиваться того, чтобы она справлялась с имеющейся нагрузкой. Для этого можно настраивать параметры СУБД, а также настраивать операционную систему. Если настройки не помогают, при таком подходе остается только модернизировать аппаратуру (что тоже помогает не всегда).

Другой подход состоит в том, чтобы не приспосабливаться под нагрузку, а уменьшать ее. 'Полезная' нагрузка формируется запросами. Если удается найти узкое место, то можно попробовать тем или иным способом повлиять на выполнение запроса и получить тот же результат, потратив меньше ресурсов. Такой способ действует более локально (на отдельный запрос или ряд запросов), но уменьшение нагрузки благоприятно сказывается и на работе всей системы.

Обычный удобный способ узнать время выполнения и время планирования — команда `EXPLAIN ANALYZE`. Ее основное назначение — показать план выполнения запроса.

Этапы, которые проходит запрос для получения результата:
1. Подключение к серверу PostgreSQL,
2. Синтаксическая проверка запроса, создание дерева запроса,
3. Система правил принимает дерево запроса и ищет в системных каталогах правила для применения к этому дереву. Обнаружив подходящие правила, она выполняет преобразования, заданные в теле правил,
4. Планировщик/оптимизатор принимает дерево запроса и создаёт план запроса. Он выбирает план, сначала рассматривая все возможные варианты получения одного и того же результата. Затем оценивается стоимость каждого варианта и выбирается самый дешёвый. Затем выбранный вариант разворачивается в полноценный план, который сможет использовать исполнитель.
5. Исполнитель рекурсивно проходит по дереву плана и получает строки тем способом, который указан в плане. Он сканирует отношения, обращаясь к системе хранения, выполняет сортировку и соединения, вычисляет условия фильтра и, наконец, возвращает полученные строки.


### JIT

Динамическая компиляция JIT (just-in-time, 'точно в нужное время') используется для компиляции кода или его фрагментов в момент выполнения программы. Эта технология позволяет ускорить выполнение интерпретируемого кода и используется во многих системах. В PostgreSQL с помощью JIT-компиляции можно скомпилировать часть кода, который выполняется при работе запросов SQL. Для этого PostgreSQL должен быть собран с поддержкой LLVM.JIT-компиляция лучше подходит для длительных, нагружающих процессор аналитических запросов. Для коротких OLTP-запросов накладные расходы на JIT-компиляцию могут превышать время выполнения самих запросов. Влиять на JIT-компиляцию можно с помощью конфигурационных параметров. Есть несколько оптимизаций, связанных с JIT, они включаются, только если стоимость запроса превышает указанное в соответствующих параметрах граничное значение.

`SHOW jit;`     проверка, включен ли параметр (по-умолчанию включен)
`SET jit = off;`    отключение параметра

